---
kind: pipeline
type: exec
name: Build all hosts

platform:
  os: linux
  arch: amd64

clone:
  depth: 1

steps:

- name: copy deploy_key to id_rsa
  environment:
    SSH_KEY:
      from_secret: deploy_key
  commands:
    - mkdir ~/.ssh
    - echo "$SSH_KEY" >> ~/.ssh/id_rsa
    - chmod 400 ~/.ssh/id_rsa
    - echo "github.com ssh-rsa AAAAB3NzaC1yc2EAAAABIwAAAQEAq2A7hRGmdnm9tUDbO9IDSwBK6TbQa+PXYPCPy6rbTrTtw7PHkccKrpp0yVhyCOV0wzfjIJNlGEYsdlLJizHhbn2mUjvSAHQqZETYP81eFzLQNnPHt4EVVUh7VfDESU84KezmD5QlWpXLmvU31/yMf+Se8xhHTvKSCZIFIeqqUUmpaaasXVal72J+UX2B+2RPW3RcT0eOzQgqlJL3RKrTJvdsjE3JEAvGq3lGHSZXy28G3skua2SmVi/w4yCE6gbODqnTWlg7+wC604y=" > ~/.ssh/known_hosts
    - eval "$(ssh-agent -s)"
    - ssh-add ~/.ssh/id_rsa
    - git clone git@github.com:luksab/nixos-private.git

- name: Show flake info
  commands:
  - nix flake show
  - nix flake metadata
  - nix flake check

- name: Build laptop
  commands:
  - nix build -v '.#nixosConfigurations.laptop.config.system.build.toplevel' --show-trace

- name: Build arm
  commands:
  - nix build -v '.#nixosConfigurations.arm.config.system.build.toplevel' --show-trace

- name: Build pi4b
  commands:
  - nix build -v '.#nixosConfigurations.pi4b.config.system.build.toplevel' --show-trace

trigger:
  event:
  - push
  - pull_request

---
kind: pipeline
type: exec
name: build flake update

platform:
  os: linux
  arch: amd64

clone:
  depth: 1

steps:

- name: create result-old files
  commands:
  - nix build -v '.#nixosConfigurations.laptop.config.system.build.toplevel' --option binary-caches "https://cache.nixos.org"
  - mv result laptop-old
  - nix build -v '.#nixosConfigurations.arm.config.system.build.toplevel' --option binary-caches "https://cache.nixos.org"
  - mv result arm-old
  - nix build -v '.#nixosConfigurations.pi4b.config.system.build.toplevel' --option binary-caches "https://cache.nixos.org"
  - mv result pi4b-old

- name: flake update
  commands:
  - nix --experimental-features "nix-command flakes" flake update
  
- name: Show git diff
  commands:
  - git diff

- name: Show flake info
  commands:
  - nix --experimental-features "nix-command flakes" flake show
  - nix --experimental-features "nix-command flakes" flake metadata
  - nix --experimental-features "nix-command flakes" flake check

- name: Build laptop
  commands:
  - nix build -v '.#nixosConfigurations.laptop.config.system.build.toplevel'
  - mv result laptop-new

- name: Build arm
  commands:
  - nix build -v '.#nixosConfigurations.arm.config.system.build.toplevel' --option binary-caches "https://cache.nixos.org"
  - mv result arm-new

- name: Build pi4b
  commands:
  - nix build -v '.#nixosConfigurations.pi4b.config.system.build.toplevel' --option binary-caches "https://cache.nixos.org"
  - mv result pi4b-new

- name: Print report
  commands:
  - echo "laptop:" && nix store diff-closures $(readlink -f laptop-old) $(readlink -f laptop-new)
  - echo "arm:" && nix store diff-closures $(readlink -f arm-old) $(readlink -f arm-new)
  - echo "pi4b:" && nix store diff-closures $(readlink -f pi4b-old) $(readlink -f pi4b-new)

trigger:
  branch:
  - main
  event:
  - pull_request
  - cron
